---
layout: post
title: "Django项目开发流程"
date: 2019-12-09 18:26:40
category: 'notes'
tags:
- Python
- 项目
- Django
---
* content
{:toc}

Django项目开发流程













# 项目简介
### 项目描述
1. 项目名称:图书商城管理系统  
2. 架构:前后端不分离MVT  
3. 成果:完整的支付流程,除了后台列表和新增其余相似功能只做一遍  
4. 开发周期:2019/12/09-2019/12/20  
5. 收获:熟悉了Django框架,知道了一个项目整体结构,基本功能都能实现了

### 项目技术
1. [Python3.7](https://docs.python.org/3.7/)  
2. [Django2.2](https://docs.djangoproject.com/en/2.2/)  
3. [jQuery(js框架)](https://api.jquery.com/)  
4. [amazeui(css框架)](http://amazeui.shopxo.net/getting-started/?_ver=2.x)  
5. [MySQL5.7](https://dev.mysql.com/doc/refman/5.7/en/)

### 应用软件
1. PyCharm  
2. Sqlyog  
3. 花生壳  
4. 支付宝开发助手1.0.2  
5. Xftp6.0  
6. Xshell6.0  

### 包文件
```
(venv) D:\OngoingProjects\bookshop>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

Django==2.2.3
mysqlclient==1.4.4
Pillow==6.2.0
requests==2.22.0
pycryptodomex==3.7.2
pycryptodome==3.9.0
python-alipay-sdk==1.10.1
```

# 需求分析

### 创建流程
1. 创建github或码云仓库  
2. 克隆到本地(这里用的http协议)`git clone https://gitee.com/caoyang7/bookshop.git`  
3. 编写readme文件  
4. 创建虚拟环境`python -m venv venv`  
5. 进入虚拟环境`cd venv/Scripts`,运行虚拟环境`activate`  
6. 右键以pycharm项目形式打开,检查当前环境是否是虚拟环境  
7. 安装环境包  
	django2.2.6  
	mysqlclient  
8. 在bookshop文件夹下创建项目`django-admin startproject web`  
9. 新建templates和static文件夹,修改settings.py文件  
10. 创建数据库`create database bookshop default charset=utf8mb4;`  
11. 写视图函数和路由  
12. 推到码云  
	添加远程仓库地址`git remote set-url --add origin git@gitee.com:caoyang7/bookshop.git`  
	删除远程仓库地址`git remote set-url --delete origin https://gitee.com/caoyang7/bookshop.git`  
	查看远程仓库地址`git remote -v`  
	给码云配置公钥,在`C:user/caoya/.ssh/id_rsa.pub`  
	提交到远程仓库`git commit -m"图书商城django项目初始化"`  
	推`git push origin`  

### 搜索和分页
[Django分页官方文档](https://docs.djangoproject.com/en/2.2/topics/pagination/)

视图函数
```python
# 导入分页类
from django.core.paginator import Paginator
from django.shortcuts import render

def index(request):
    # print(request, '-----------------')
    '''
    默认:< WSGIRequest: GET '/myadmin/users/index?page=1' >
    搜索姓名为曹阳:<WSGIRequest: GET '/myadmin/users/index?selecttype=nickname&keywords=%E6%9B%B9%E9%98%B3'>
    搜索所有字段中含134的第2页:<WSGIRequest: GET '/myadmin/users/index?page=2&selecttype=all&keywords=134'> 
    '''
    
    # 1.查询所有的会员数据,filter过滤查询,模型查询是and条件,什么时候用数据什么时候查
    data = Users.objects.filter()

    # 7.接收搜索条件
    selecttype = request.GET.get('selecttype', None)
    keywords = request.GET.get('keywords', None)
    if selecttype:
        # 有搜索条件
        if selecttype == "all":
			# select * from users where name like '%a%' or phone like '%a%'
            # 按照多字段进行条件搜索:导入Q对象,模型查询就能用or条件了
            from django.db.models import Q
			data = data.filter(
                Q(phone__contains=keywords) | Q(nickname__contains=keywords) | Q(sex__contains=keywords) | Q(
                    usertype__contains=keywords))
        else:
			# 模型查询:是否包含方法__contains
            serdata = {f'{selecttype}__contains': keywords}
            # print(serdata,'-----------------')
            '''
            {'nickname__contains': '曹阳'}
            '''
			# 关键字参数 搜索条件是键 关键字是值
            data = data.filter(**serdata)
            
    # print(data,'----------------------------')
    '''
    默认:
        < QuerySet[ 
            < Users: Users object(515) >, 
            < Users: Users object(517) >, 
            < Users: Users object(518) >,
            < Users: Users object(519) >, 
            < Users: Users object(520) >, 
            < Users: Users object(521) >, 
            < Users: Users object(522) >
        ] >
    姓名为曹阳:<QuerySet [<Users: Users object (515)>]> 
    所有字段含134:
        <QuerySet [
            <Users: Users object (515)>, 
            <Users: Users object (519)>, 
            <Users: Users object (520)>, 
            <Users: Users object (521)>
        ]>
    '''
			
	# 2.实例化分页对象 参数1:数据集,参数2:每页显示的条数
    p = Paginator(data, 3)
    # 6.接收当前的页码数
    inx_p = request.GET.get('page', 1)
    # 3.获取当前页的数据
    userlist = p.get_page(inx_p)
    # print(userlist, '-------------------------')
    '''
    默认:<Page 1 of 3> 
    <Page 1 of 3> 
    <Page 2 of 2>
    '''

    # 4.分配数据
    content = {'data': userlist, 'contacts': userlist}
    # print(content, '-------------------------')
    '''
    默认:{'data': <Page 1 of 3>, 'contacts': <Page 1 of 3>}
    {'data': <Page 1 of 1>, 'contacts': <Page 1 of 1>} 
    {'data': <Page 2 of 2>, 'contacts': <Page 2 of 2>} 
    '''
    # 5.加载模板
    return render(request, 'myadmin/users/index.html', content)

```

模板中
```html
<form action="">
<div class="am-u-sm-12 am-u-md-6 am-u-lg-3">
	<div class="am-form-group tpl-table-list-select">
		<select name="selecttype" data-am-selected="{btnSize: 'sm'}" style="display: none;">
			<option value="all" {% if request.GET.selecttype == 'all' %} selected {% endif %}>所有类别</option>
			<option value="phone" {% if request.GET.selecttype == 'phone' %} selected {% endif %}>手机号</option>
			<option value="nickname" {% if request.GET.selecttype == 'nickname' %} selected {% endif %}>昵称</option>
			<option value="sex" {% if request.GET.selecttype == 'sex' %} selected {% endif %}>性别</option>
			<option value="usertype" {% if request.GET.selecttype == 'usertype' %} selected {% endif %}>身份</option>
		</select>
	</div>
</div>
<div class="am-u-sm-12 am-u-md-12 am-u-lg-3">
	<div class="am-input-group am-input-group-sm tpl-form-border-form cl-p">
		<input type="text" value="{{ request.GET.keywords }}" name="keywords" class="am-form-field ">
		<span class="am-input-group-btn">
			<button class="am-btn  am-btn-default am-btn-success tpl-table-list-field am-icon-search" ></button>
		</span>
	</div>
</div>
</form>

<div class="am-u-lg-12 am-cf">
	<div class="am-fr">
		<ul class="am-pagination tpl-pagination">
			<li>总页数:{{ data.paginator.num_pages }}</li>
			<li>总条数:{{ data.paginator.count }}</li>
			{% load pagetag %}
			<!-- 使用自定义分页优化标签showpage data当前页的数据 paginator分页对象 num_pages获取总页数方法 request请求对象 -->
			{% showpage data.paginator.num_pages request %}
		</ul>
	</div>
</div>
```

自定义标签(templatetags文件夹名不能改)
```python
# 导入template模板
from django import template
# s += f'<li><a href="?page=1{args}">首页</a></li>'模板引擎是html时返回return format_html(s)会转义成实体图
from django.utils.html import format_html

# 用模板调用Library类
# register是个装饰器,可以调用方法自定义过滤器和标签
register = template.Library()
# print(register, '----------------')
'''
默认:<django.template.library.Library object at 0x00000216C2B8C128> 
<django.template.library.Library object at 0x0000013888CB85C0> 
'''

# 自定义过滤器:调用filter方法
@register.filter
def kong_upper(val):
	'''
	# 接收一个参数,转成大写
	# 在模板中用{ { 'iloveyou'|kong_upper } }调用
	'''
	# print ('val from template:',val)
    return val.upper()


# 自定义加标签
@register.simple_tag
def jia(a, b):
    res = int(a) + int(b)
    return res


# 自定义乘标签
@register.simple_tag
def cheng(a, b):
    res = a * b
    # return res
    return '%.2f' % res


# 自定义分页优化标签:调用simple_tag方法
@register.simple_tag
def showpage(num, request):
    '''
        num 总页数
        p   当前页
		request 请求对象
		功能 每页最多显示10个页码数
		在模板中用{ % showpage 100 10 % }调用
    '''
    # print(num,request, '-----------------')
    '''
    默认:3 <WSGIRequest: GET '/myadmin/users/index?page=1'>
    1 <WSGIRequest: GET '/myadmin/users/index?selecttype=nickname&keywords=%E6%9B%B9%E9%98%B3'>
    2 <WSGIRequest: GET '/myadmin/users/index?page=2&selecttype=all&keywords=134'>
    '''
    
    # 获取当前页码数,没有默认为1
    p = int(request.GET.get('page', 1))

    # 获取当前页面的请求参数
    data = request.GET.dict()
    # print(data, '----------------')
    '''
    默认:{'page': '1'} 
    {'selecttype': 'nickname', 'keywords': '曹阳'} 
    {'page': '2', 'selecttype': 'all', 'keywords': '134'}
    '''
    args = ''
    for k, v in data.items():
        if k != 'page':
			# &selecttype=phone&keywords=09
            args += f'&{k}={v}'
    # print(args,'------------------')
    '''
    默认:&selecttype=all&keywords= 
    &selecttype=nickname&keywords=曹阳
    &selecttype=all&keywords=134
    '''

	# 正常情况(100,10):5 6 7 8 9 10 11 12 13 14
    start = p - 5
    end = p + 4

    # 判断当前页如果小于等于5:(100,5):1 2 3 4 5 6 7 8 9 10
    if p <= 5:
        start = 1
        end = 10

    # 判断当前页如果大于总页数-4:(100,97):91 92 93 94 95 96 97 98 99 100
    if p > num - 4:
        start = num - 9
        end = num

    # 总页数小于等于10:(9,5):1 2 3 4 5 6 7 8 9
    if num <= 10:
        start = 1
        end = num
	
    s = ''
	# ?page=1是点击传递参数用的 {args}是搜索的参数
    s += f'<li><a href="?page=1{args}">首页</a></li>'
    # print(s, '---------------------')
    '''
    默认:<li><a href="?page=1">首页</a></li> 
    '''
    if p - 1 == 1:
        s += f'<li class="am-disabled"><a href="?page=1{args}">上一页</a></li>'
    else:
        s += f'<li><a href="?page={p - 1}{args}">上一页</a></li>'
		
	# 遍历显示的页码
    for x in range(start, end + 1):
        if x == p:
            s += f'<li class="am-active"><a href="?page={x}{args}">{x}</a></li>'
        else:
            s += f'<li><a href="?page={x}{args}">{x}</a></li>'
    # print(s,'---------------------')
    '''
    默认:<li><a href="?page=1">首页</a></li><li class="am-disabled"><a href="?page=1">上一页</a></li><li class="am-active"><a href="?page=1">1</a></li><li><a href="?page=2">2</a></li><li><a href="?page=3">3</a></li>
    
    <li><a href="?page=1&selecttype=nickname&keywords=曹阳">首页</a></li><li class="am-disab
led"><a href="?page=1&selecttype=nickname&keywords=曹阳">上一页</a></li><li class="am-ac
tive"><a href="?page=1&selecttype=nickname&keywords=曹阳">1</a></li> 
    '''

    if p + 1 == num:
        s += f'<li class="am-disabled"><a href="?page={num}{args}">下一页</a></li>'
    else:
        s += f'<li><a href="?page={p + 1}{args}">下一页</a></li>'
    s += f'<li><a href="?page={num}{args}">尾页</a></li>'
    return format_html(s)
```
